apiVersion: tekton.dev/v1alpha1
kind: Task
metadata:
  name: sync-harbor-image
spec:
  inputs:
    params:
      - name: inHarborUrl
        type: string
      - name: inHarborUsername
        type: string
      - name: inHarborPassword
        type: string
      - name: inProjectName
        type: string
      - name: inImageName
        type: string
      - name: inImageTag
        type: string
      - name: outHarborUrl
        type: string
      - name: outHarborUsername
        type: string
      - name: outHarborPassword
        type: string
      - name: outProjectName
        type: string
      - name: outImageProject
        type: string

  steps:
    - name: sync-harbor-image
      image: docker
      env:
        # Connect to the sidecar over TCP, with TLS.
        - name: DOCKER_HOST
          value: tcp://localhost:2376
        # Verify TLS.
        - name: DOCKER_TLS_VERIFY
          value: '1'
        # Use the certs generated by the sidecar daemon.
        - name: DOCKER_CERT_PATH
          value: /certs/client
      script: |
        inImage=$(inputs.params.inHarborUrl)/$(inputs.params.inProjectName)/$(inputs.params.inImageName):$(inputs.params.inImageTag)
        outImage=$(inputs.params.outHarborUrl)/$(inputs.params.outProjectName)/$(inputs.params.outImageProject)/$(inputs.params.inImageName):$(inputs.params.inImageTag)
        docker login $(inputs.params.inHarborUrl) -u $(inputs.params.inHarborUsername) -p '$(inputs.params.inHarborPassword)'
        docker login $(inputs.params.outHarborUrl) -u $(inputs.params.outHarborUsername) -p '$(inputs.params.outHarborPassword)'
        docker pull $inImage
        docker tag $inImage $outImage
        docker push $outImage


      volumeMounts:
        - mountPath: /certs/client
          name: dind-certs
  sidecars:
    - image: docker:dind
      name: server
      args:
        - --storage-driver=vfs
        - --userland-proxy=false
        - --debug
      securityContext:
        privileged: true
      env:
        # Write generated certs to the path shared with the client.
        - name: DOCKER_TLS_CERTDIR
          value: /certs
      volumeMounts:
        - mountPath: /certs/client
          name: dind-certs
      # Wait for the dind daemon to generate the certs it will share with the
      # client.
      readinessProbe:
        periodSeconds: 1
        exec:
          command: ['ls', '/certs/client/ca.pem']

  volumes:
    - name: dind-certs
      emptyDir: {}
